<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-|
Module      : Htcc.Asm.Intrinsic.Structure.Internal
Description : The modules of intrinsic (x86_64) assembly
Copyright   : (c) roki, 2019
License     : MIT
Maintainer  : falgon53@yahoo.co.jp
Stability   : experimental
Portability : POSIX

The modules of intrinsic (x86_64) assembly
-}</span><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings, TupleSections #-}</span><span>
</span><a name="line-13"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Htcc.Asm.Intrinsic.Structure.Internal</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-14"></a><span>    </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-type">Asm</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>    </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#AsmInfo"><span class="hs-identifier hs-type">AsmInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>    </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#AsmCodeCtx"><span class="hs-identifier hs-type">AsmCodeCtx</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>    </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#unCtx"><span class="hs-identifier hs-var">unCtx</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>    </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#runAsm"><span class="hs-identifier hs-var">runAsm</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>    </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#putStrWithIndent"><span class="hs-identifier hs-var">putStrWithIndent</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>    </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#putStrLnWithIndent"><span class="hs-identifier hs-var">putStrLnWithIndent</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>    </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#errCtx"><span class="hs-identifier hs-var">errCtx</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>    </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#writeCurFn"><span class="hs-identifier hs-var">writeCurFn</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>    </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#section"><span class="hs-identifier hs-var">section</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>    </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#labeled"><span class="hs-identifier hs-var">labeled</span></a><span>
</span><a name="line-25"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IORef</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">writeIORef</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Semigroup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Semigroup</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Text</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Text.IO</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Finally</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadFinally</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="Htcc.Utils.html"><span class="hs-identifier">Htcc.Utils</span></a><span> </span><span class="hs-special">(</span><a href="Htcc.Utils.Print.html#err"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-comment">-- | Counter and label information used when generating assembly code</span><span>
</span><a name="line-36"></a><span class="hs-keyword">data</span><span> </span><a name="AsmInfo"><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#AsmInfo"><span class="hs-identifier">AsmInfo</span></a></a><span> </span><a name="local-6989586621679158529"><a href="#local-6989586621679158529"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="AsmInfo"><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#AsmInfo"><span class="hs-identifier">AsmInfo</span></a></a><span>
</span><a name="line-37"></a><span>    </span><span class="hs-special">{</span><span>
</span><a name="line-38"></a><span>        </span><a name="inLabel"><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#inLabel"><span class="hs-identifier">inLabel</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- ^ the flag that indicates whether it is inside the label. If True, indent by single tab,</span><span>
</span><a name="line-39"></a><span>        </span><a name="lblCnt"><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#lblCnt"><span class="hs-identifier">lblCnt</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><a href="#local-6989586621679158529"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">,</span><span> </span><span class="hs-comment">-- ^ the label counter</span><span>
</span><a name="line-40"></a><span>        </span><a name="brkCnt"><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#brkCnt"><span class="hs-identifier">brkCnt</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679158529"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- ^ the @break@ label counter</span><span>
</span><a name="line-41"></a><span>        </span><a name="cntCnt"><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#cntCnt"><span class="hs-identifier">cntCnt</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679158529"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- ^ the @continue@ label counter</span><span>
</span><a name="line-42"></a><span>        </span><a name="curFn"><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#curFn"><span class="hs-identifier">curFn</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">T.Text</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ the function being processed</span><span>
</span><a name="line-43"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span class="hs-comment">-- | A monad that represents the context of the assembly code</span><span>
</span><a name="line-46"></a><span class="hs-keyword">newtype</span><span> </span><a name="Asm"><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier">Asm</span></a></a><span> </span><a name="local-6989586621679158526"><a href="#local-6989586621679158526"><span class="hs-identifier">ctx</span></a></a><span> </span><a name="local-6989586621679158527"><a href="#local-6989586621679158527"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621679158528"><a href="#local-6989586621679158528"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Asm"><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier">Asm</span></a></a><span>
</span><a name="line-47"></a><span>    </span><span class="hs-special">{</span><span>
</span><a name="line-48"></a><span>        </span><a name="unAsm"><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#unAsm"><span class="hs-identifier">unAsm</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#AsmInfo"><span class="hs-identifier hs-type">AsmInfo</span></a><span> </span><a href="#local-6989586621679158527"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679158528"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-comment">-- ^ Function that determines the structure of assembly code</span><span>
</span><a name="line-49"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><span class="hs-special">(</span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-type">Asm</span></a><span> </span><a href="#local-6989586621679158553"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621679158554"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-52"></a><span>    </span><a name="local-3458764513820541101"><span class="hs-identifier">fmap</span></a><span> </span><a name="local-6989586621679158555"><a href="#local-6989586621679158555"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679158556"><a href="#local-6989586621679158556"><span class="hs-identifier">asm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-var">Asm</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621679158555"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">unAsm</span><span> </span><a href="#local-6989586621679158556"><span class="hs-identifier hs-var">asm</span></a><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><span class="hs-special">(</span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-type">Asm</span></a><span> </span><a href="#local-6989586621679158548"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621679158549"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-55"></a><span>    </span><a name="local-3458764513820541680"><span class="hs-identifier">pure</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-var">Asm</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">return</span><span>
</span><a name="line-56"></a><span>    </span><a name="local-6989586621679158550"><a href="#local-6989586621679158550"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-3458764513820541679"><span class="hs-operator">&lt;*&gt;</span></a><span> </span><a name="local-6989586621679158551"><a href="#local-6989586621679158551"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-var">Asm</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679158552"><a href="#local-6989586621679158552"><span class="hs-identifier">ai</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">unAsm</span><span> </span><a href="#local-6989586621679158550"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679158552"><span class="hs-identifier hs-var">ai</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier">unAsm</span><span> </span><a href="#local-6989586621679158551"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679158552"><span class="hs-identifier hs-var">ai</span></a><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><span class="hs-special">(</span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-type">Asm</span></a><span> </span><a href="#local-6989586621679158543"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621679158544"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-59"></a><span>    </span><a name="local-3458764513820541102"><span class="hs-identifier">return</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span>
</span><a name="line-60"></a><span>    </span><a name="local-6989586621679158545"><a href="#local-6989586621679158545"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-3458764513820541099"><span class="hs-operator">&gt;&gt;=</span></a><span> </span><a name="local-6989586621679158546"><a href="#local-6989586621679158546"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-var">Asm</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679158547"><a href="#local-6989586621679158547"><span class="hs-identifier">ai</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">unAsm</span><span> </span><a href="#local-6989586621679158545"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679158547"><span class="hs-identifier hs-var">ai</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier">unAsm</span><span> </span><a href="#local-6989586621679158547"><span class="hs-identifier hs-var">ai</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679158546"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadFinally</span><span> </span><span class="hs-special">(</span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-type">Asm</span></a><span> </span><a href="#local-6989586621679158536"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621679158537"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-63"></a><span>    </span><a name="local-8214565720323809797"><span class="hs-identifier">bracket'</span></a><span> </span><a name="local-6989586621679158538"><a href="#local-6989586621679158538"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679158539"><a href="#local-6989586621679158539"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621679158540"><a href="#local-6989586621679158540"><span class="hs-identifier">mc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-64"></a><span>        </span><a name="local-6989586621679158541"><a href="#local-6989586621679158541"><span class="hs-identifier">r'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679158538"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-65"></a><span>        </span><a name="local-6989586621679158542"><a href="#local-6989586621679158542"><span class="hs-identifier">a'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679158540"><span class="hs-identifier hs-var">mc</span></a><span> </span><a href="#local-6989586621679158541"><span class="hs-identifier hs-var">r'</span></a><span>
</span><a name="line-66"></a><span>        </span><span class="hs-special">(</span><a href="#local-6989586621679158542"><span class="hs-identifier hs-var">a'</span></a><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679158539"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679158541"><span class="hs-identifier hs-var">r'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679158542"><span class="hs-identifier hs-var">a'</span></a><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Semigroup</span><span> </span><span class="hs-special">(</span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-type">Asm</span></a><span> </span><a href="#local-6989586621679158533"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621679158534"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679158535"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-69"></a><span>    </span><span class="hs-special">(</span><a name="local-3458764513820541482"><span class="hs-operator">&lt;&gt;</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">*&gt;</span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monoid</span><span> </span><a href="#local-6989586621679158530"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Monoid</span><span> </span><span class="hs-special">(</span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-type">Asm</span></a><span> </span><a href="#local-6989586621679158531"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621679158532"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679158530"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-72"></a><span>    </span><a name="local-3458764513820541483"><span class="hs-identifier">mempty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-var">Asm</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-73"></a><span>    </span><a name="local-3458764513820541484"><span class="hs-identifier">mappend</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-comment">-- | Type representing assembly code</span><span>
</span><a name="line-76"></a><span class="hs-keyword">data</span><span> </span><a name="AsmCodeCtx"><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#AsmCodeCtx"><span class="hs-identifier">AsmCodeCtx</span></a></a><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-comment">-- | the function to switch context</span><span>
</span><a name="line-79"></a><span class="hs-identifier">unCtx</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-type">Asm</span></a><span> </span><a href="#local-6989586621679158573"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621679158574"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679158575"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-type">Asm</span></a><span> </span><a href="#local-6989586621679158576"><span class="hs-identifier hs-type">ctx'</span></a><span> </span><a href="#local-6989586621679158574"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679158575"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-80"></a><a name="unCtx"><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#unCtx"><span class="hs-identifier">unCtx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-var">Asm</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">unAsm</span><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span class="hs-comment">-- | the executor that outputs assembly code</span><span>
</span><a name="line-83"></a><span class="hs-identifier">runAsm</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Num</span><span> </span><a href="#local-6989586621679158571"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Enum</span><span> </span><a href="#local-6989586621679158571"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-type">Asm</span></a><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#AsmCodeCtx"><span class="hs-identifier hs-type">AsmCodeCtx</span></a><span> </span><a href="#local-6989586621679158571"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679158572"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679158572"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-84"></a><a name="runAsm"><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#runAsm"><span class="hs-identifier">runAsm</span></a></a><span> </span><a name="local-6989586621679158577"><a href="#local-6989586621679158577"><span class="hs-identifier">asm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-85"></a><span>    </span><span class="hs-identifier hs-var">putStrLn</span><span> </span><span class="hs-string">&quot;.intel_syntax noprefix&quot;</span><span>
</span><a name="line-86"></a><span>    </span><a name="local-6989586621679158578"><a href="#local-6989586621679158578"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-87"></a><span>    </span><a name="local-6989586621679158579"><a href="#local-6989586621679158579"><span class="hs-identifier">brk</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-88"></a><span>    </span><a name="local-6989586621679158580"><a href="#local-6989586621679158580"><span class="hs-identifier">cnt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-89"></a><span>    </span><a name="local-6989586621679158581"><a href="#local-6989586621679158581"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-90"></a><span>    </span><span class="hs-identifier">unAsm</span><span> </span><a href="#local-6989586621679158577"><span class="hs-identifier hs-var">asm</span></a><span> </span><span class="hs-special">(</span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#AsmInfo"><span class="hs-identifier hs-var">AsmInfo</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621679158578"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621679158579"><span class="hs-identifier hs-var">brk</span></a><span> </span><a href="#local-6989586621679158580"><span class="hs-identifier hs-var">cnt</span></a><span> </span><a href="#local-6989586621679158581"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-comment">-- | print a string with indentation, output is broken on a new line</span><span>
</span><a name="line-93"></a><span class="hs-identifier">putStrLnWithIndent</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">T.Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-type">Asm</span></a><span> </span><a href="#local-6989586621679158569"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621679158570"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-94"></a><a name="putStrLnWithIndent"><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#putStrLnWithIndent"><span class="hs-identifier">putStrLnWithIndent</span></a></a><span> </span><a name="local-6989586621679158582"><a href="#local-6989586621679158582"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-var">Asm</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679158583"><a href="#local-6989586621679158583"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">T.putStrLn</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">inLabel</span><span> </span><a href="#local-6989586621679158583"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-char">'\t'</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T.cons</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679158582"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679158582"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span class="hs-comment">-- | print a string with indentation</span><span>
</span><a name="line-97"></a><span class="hs-identifier">putStrWithIndent</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">T.Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-type">Asm</span></a><span> </span><a href="#local-6989586621679158567"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621679158568"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-98"></a><a name="putStrWithIndent"><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#putStrWithIndent"><span class="hs-identifier">putStrWithIndent</span></a></a><span> </span><a name="local-6989586621679158584"><a href="#local-6989586621679158584"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-var">Asm</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679158585"><a href="#local-6989586621679158585"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">T.putStr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">inLabel</span><span> </span><a href="#local-6989586621679158585"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-char">'\t'</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T.cons</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679158584"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679158584"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span class="hs-comment">-- | The error context.</span><span>
</span><a name="line-101"></a><span class="hs-comment">-- when this is executed, </span><span>
</span><a name="line-102"></a><span class="hs-comment">-- it will exit the application immediately with `System.Exit.exitFailure` after printing the message.</span><span>
</span><a name="line-103"></a><span class="hs-identifier">errCtx</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">T.Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-type">Asm</span></a><span> </span><a href="#local-6989586621679158565"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621679158566"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-104"></a><a name="errCtx"><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#errCtx"><span class="hs-identifier">errCtx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-var">Asm</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Htcc.Utils.Print.html#err"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span class="hs-comment">-- | rewriting functions during processing</span><span>
</span><a name="line-107"></a><span class="hs-identifier">writeCurFn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">T.Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-type">Asm</span></a><span> </span><a href="#local-6989586621679158563"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621679158564"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-108"></a><a name="writeCurFn"><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#writeCurFn"><span class="hs-identifier">writeCurFn</span></a></a><span> </span><a name="local-6989586621679158586"><a href="#local-6989586621679158586"><span class="hs-identifier">fname</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-var">Asm</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679158587"><a href="#local-6989586621679158587"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">writeIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">curFn</span><span> </span><a href="#local-6989586621679158587"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679158586"><span class="hs-identifier hs-var">fname</span></a><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-comment">-- | represents a section of assembly code</span><span>
</span><a name="line-111"></a><span class="hs-identifier">section</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">T.Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-type">Asm</span></a><span> </span><a href="#local-6989586621679158560"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621679158561"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679158562"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-type">Asm</span></a><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#AsmCodeCtx"><span class="hs-identifier hs-type">AsmCodeCtx</span></a><span> </span><a href="#local-6989586621679158561"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679158562"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-112"></a><a name="section"><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#section"><span class="hs-identifier">section</span></a></a><span> </span><a name="local-6989586621679158588"><a href="#local-6989586621679158588"><span class="hs-identifier">sec</span></a></a><span> </span><a name="local-6989586621679158589"><a href="#local-6989586621679158589"><span class="hs-identifier">asm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#putStrLnWithIndent"><span class="hs-identifier hs-var">putStrLnWithIndent</span></a><span> </span><span class="hs-special">(</span><span class="hs-char">'.'</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T.cons</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679158588"><span class="hs-identifier hs-var">sec</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#unCtx"><span class="hs-identifier hs-var">unCtx</span></a><span> </span><a href="#local-6989586621679158589"><span class="hs-identifier hs-var">asm</span></a><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span class="hs-comment">-- | switch to process in label</span><span>
</span><a name="line-115"></a><span class="hs-identifier">labeled</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-type">Asm</span></a><span> </span><a href="#local-6989586621679158557"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621679158558"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679158559"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-type">Asm</span></a><span> </span><a href="#local-6989586621679158557"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621679158558"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679158559"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-116"></a><a name="labeled"><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#labeled"><span class="hs-identifier">labeled</span></a></a><span> </span><a name="local-6989586621679158590"><a href="#local-6989586621679158590"><span class="hs-identifier">asm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Htcc.Asm.Intrinsic.Structure.Internal.html#Asm"><span class="hs-identifier hs-var">Asm</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679158591"><a href="#local-6989586621679158591"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">unAsm</span><span> </span><a href="#local-6989586621679158590"><span class="hs-identifier hs-var">asm</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679158591"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inLabel</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-117"></a></pre></body></html>